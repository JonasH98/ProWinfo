<!DOCTYPE html>
<html lang="en">
  <head>
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link rel="stylesheet" href="../css/styles.css" />
    <link rel="stylesheet" href="../css/overview.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
      integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w=="
      crossorigin="anonymous"
    />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="../js/login_check.js" defer></script>
    <title>Autovermietung</title>
  </head>

  <body>
    <navbar>
      <div class="nav-group">
        <a href="index.html">
          <img
            src="../images/OneStopLogo_Light.png"
            alt="LOGO"
            class="brand-logo"
        /></a>
      </div>
      <div class="nav-group">
        <h1>Autos</h1>
      </div>
      <div class="nav-group nav-group-authentication">
        <a href="login.html"><button>Login</button></a>
        <a href="login.html?tab=register-form"><button>Registrieren</button></a>
      </div>
    </navbar>
    <main>
      <div class="sidebar sidebar-left">
        <div class="sidebar-header">
          <h3>Filtern</h3>
          <i class="fas fa-times-circle fa-lg"></i>
        </div>
        <div class="sidebar-content">
          <!--##############################-->
          <div class="filter-group filter-group-car-type">
            <div class="filter-group-header">
              <h3>Auto-Typ</h3>
            </div>
            <div class="filter-group-content">
              <div class="filter-btn filter-btn-car-type" db_id="1">
                <i class="fas fa-car"></i>
                <span>Kleinwagen</span>
              </div>
              <div class="filter-btn filter-btn-car-type" db_id="2">
                <i class="fas fa-car"></i>
                <span>Kompaktwagen</span>
              </div>
              <div class="filter-btn filter-btn-car-type" db_id="3">
                <i class="fas fa-car"></i>
                <span>Mittelklasse</span>
              </div>
              <div class="filter-btn filter-btn-car-type" db_id="4">
                <i class="fas fa-car"></i>
                <span>Oberklasse</span>
              </div>
              <div class="filter-btn filter-btn-car-type" db_id="5">
                <i class="fas fa-car"></i>
                <span>SUV</span>
              </div>
              <div class="filter-btn filter-btn-car-type" db_id="6">
                <i class="fas fa-car"></i>
                <span>Kombi</span>
              </div>
            </div>
          </div>
          <!--##############################-->
          <!--##############################-->
          <div class="filter-group filter-group-doors">
            <div class="filter-group-header">
              <h3>Türen</h3>
            </div>
            <div class="filter-group-content">
              <div class="filter-btn filter-btn-doors" db_id="2-3">
                <span>2-3</span>
              </div>
              <div class="filter-btn filter-btn-doors" db_id="4-5">
                <span>4-5 </span>
              </div>
            </div>
          </div>
          <!--##############################-->
          <!--##############################-->
          <div class="filter-group filter-group-features">
            <div class="filter-group-header">
              <h3>Zubehör</h3>
            </div>
            <div class="filter-group-content">
              <div class="filter-btn filter-btn-features" db_id="1">
                <span>Navigation</span>
              </div>
              <div class="filter-btn filter-btn-features" db_id="2">
                <span>Klimaanlage</span>
              </div>
              <div class="filter-btn filter-btn-features" db_id="3">
                <span>Automatik</span>
              </div>
              <div class="filter-btn filter-btn-features" db_id="4">
                <span>Winterreifen</span>
              </div>
            </div>
          </div>
          <!--##############################-->
          <!--##############################-->
          <div class="filter-group filter-group-extras">
            <div class="filter-group-header">
              <h3>Extras</h3>
            </div>
            <div class="filter-group-content">
              <div class="filter-btn filter-btn-extras" db_id="1">
                <span>Haftpflichtversicherung</span>
              </div>
              <div class="filter-btn filter-btn-extras" db_id="2">
                <span>Freikilometer(750)</span>
              </div>
              <div class="filter-btn filter-btn-extras" db_id="3">
                <span>Freikilometer(1500)</span>
              </div>
              <div class="filter-btn filter-btn-extras" db_id="4">
                <span>Glasschutz & Reifenschutz</span>
              </div>
            </div>
          </div>
          <!--##############################-->
        </div>
        <div class="sidebar-actions">
          <button class="submit-filter btn-small">Filter anwenden</button>
        </div>
      </div>
      <div class="content">
        <lottie-player
          id="loading-animation-lottie"
          src="https://assets10.lottiefiles.com/packages/lf20_QPewua.json"
          background="transparent"
          speed="2"
          style="width: 300px; height: 300px"
          loop
          autoplay
        ></lottie-player>
      </div>
      <!-- <div class="sidebar sidebar-right">
        <div class="sidebar-header">
          <i class="fas fa-times-circle fa-lg"></i>
          <h3>Filtern</h3>
        </div>
      </div> -->
    </main>
  </body>
  <script>
    const createCarElement = (data) => {
      const features = data.features
        .map((feature) => `<span>- ${feature.name}</span><br>`)
        .join(" ");

      const extras = data.extras
        .map((extra) => `<span>- ${extra.name}</span><br>`)
        .join(" ");
      return /*html*/ `<div class="car-item">
          <div class="car-img">
            <img
              src=${data.imgUrl}
              width="300"
            />
          </div>
          <div class="car-info">
            <div class="car-header">
              <h1 class="car-name">${data.name}</h1>
            </div>
            <div class="car-info-content">
              <div class="car-specification car-type">
                <h2 class="car-specification-header">
                  <i class="fas fa-car"></i> Auto-Typ
                </h2>
                <span>${data.type}</span>
              </div>
              <div class="car-specification doors">
                <h2 class="car-specification-header">
                  <i class="fas fa-door-open"></i> Türen
                </h2>
                <span>${data.doors}</span>
              </div>
              <div class="car-specification car-features">
                <h2 class="car-specification-header">
                  <i class="fas fa-star"></i> Zubehör
                </h2>
                ${features}
              </div>
              <div class="car-specification car-extras">
                <h2 class="car-specification-header">
                  <i class="far fa-star"></i> Extras
                </h2>
                ${extras}
              </div>
              <div class="car-specification car-extras">
                <h2 class="car-specification-header">
                  <i class="fas fa-map-marker-alt"></i> Ort
                </h2>
                ${data.location}
              </div>
              <div class="car-specification car-price">
                <h2 class="car-specification-header">
                  <i class="far fa-money-bill-alt"></i> Preis
                </h2>
                ${data.price + " €"}
              </div>
            </div>
          </div>
          <div class="car-actions">
            <button onclick="reserveCar('${data.type_id}')">Reservieren</button>
          </div>
        </div>`;
    };

    $(".sidebar-left .sidebar-header").click(function () {
      $(".sidebar-left").toggleClass("sidebar-left-hidden");
    });
    $(".sidebar-right .sidebar-header").click(function () {
      $(".sidebar-right").toggleClass("sidebar-right-hidden");
    });
    $(".filter-btn").click(function (e) {
      $(this).toggleClass("is-selected");
    });

    const sampleData = {
      imgUrl: "https://freepngimg.com/thumb/car/3-2-car-free-download-png.png",
      name: "BMW I8",
      manufacturer: "BMW",
      type: "Oberklasse",
      doors: "3",
      features: ["Klimaanlage", "Automatik", "Navigation"],
      extras: ["Reifenschutz", "Haftpflichtversicherung"],
      location: "irgendwo im nirgendwo",
      price: 12345.67,
    };

    const getFilters = () => {
      const getIds = (selector) => {
        let ids = [];
        $(selector).each((idx, ele) => ids.push(ele.getAttribute("db_id")));
        return ids;
      };
      const cls = getIds(".filter-btn-car-type.is-selected");
      const doors = getIds(".filter-btn-doors.is-selected");
      const features = getIds(".filter-btn-features.is-selected");
      const extras = getIds(".filter-btn-extras.is-selected");
      return {
        classes: cls,
        doors: doors,
        features: features,
        extras: extras,
      };
    };
    const loadData = async () => {
      $(".content").html("");
      const filters = getFilters();
      let data = await fetch("http://localhost:3000/cars", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(filters),
      });
      data = await data.json();
      console.log(data);
      $("#loading-animation-lottie").css("display", "none");
      for (const car of data) {
        $(".content").append(
          createCarElement({
            id: car.id,
            imgUrl:
              "https://freepngimg.com/thumb/car/3-2-car-free-download-png.png",
            name: car.name,
            manufacturer: car.name,
            type: car.car_class_name,
            type_id: car.cartypeid,
            doors: car.doors,
            seats: car.seats,
            features: car.features,
            extras: car.extras,
            location: car.location,
            price: car.car_price,
          })
        );
      }
    };
    $(".submit-filter").click(async function (e) {
      $("#loading-animation-lottie").css("display", "block");
      await loadData();
    });
    loadData();

    const reserveCar = async (car_type_id) => {
      let data = await fetch("http://localhost:3000/reservation", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          car_type_id: car_type_id,
          date_from: "2020-03-24",
          date_to: "2020-04-27",
          customer_id: 2,
        }),
      });
      data = await data.json();
      console.log(data);
    };
  </script>
</html>
